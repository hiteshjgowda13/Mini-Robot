#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define BUZZER_PIN 4

#define epd_bitmap_logo_width 64
#define epd_bitmap_logo_height 32


// 'logo', 64x32px
const unsigned char epd_bitmap_logo [] PROGMEM = {
	0x00, 0x00, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x3f, 0x80, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x60, 0x01, 0x00, 0x00, 0x00, 0x00, 
	0x01, 0xfb, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xe7, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x01, 0xee, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3c, 0xce, 0x70, 0x73, 0x87, 0x8f, 0xf3, 0xfc, 
	0x3e, 0x4e, 0x70, 0x73, 0x8f, 0x1e, 0x07, 0x80, 0x3f, 0x8e, 0x70, 0x73, 0x9c, 0x1e, 0x07, 0x80, 
	0x3f, 0xce, 0x7f, 0xf3, 0xf8, 0x07, 0x81, 0xe0, 0x38, 0xfe, 0x78, 0xf3, 0xf8, 0xc1, 0xe0, 0x78, 
	0x38, 0x7f, 0x80, 0x73, 0x9e, 0x00, 0xf0, 0x3c, 0x38, 0x3f, 0xff, 0x73, 0x8f, 0x1f, 0xf3, 0xfc, 
	0x38, 0x1e, 0x20, 0x73, 0x83, 0x9f, 0xe7, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x30, 0x00, 0x10, 0x01, 0x80, 0x08, 0x00, 0x04, 0x37, 0xff, 0xd3, 0xfe, 0xbf, 0xe9, 0xff, 0xf4, 
	0x34, 0x00, 0xd2, 0x06, 0xa0, 0x69, 0x00, 0x34, 0x34, 0x78, 0xd2, 0x66, 0xaf, 0x69, 0x33, 0x34, 
	0x34, 0x6c, 0xd6, 0x86, 0xa0, 0x69, 0x03, 0x34, 0x33, 0x00, 0xd6, 0x06, 0xa0, 0x69, 0x00, 0xe4, 
	0x0e, 0x30, 0xd6, 0x18, 0x9c, 0x69, 0x0e, 0x78, 0x00, 0xe3, 0xd6, 0x30, 0x0c, 0x69, 0xe7, 0x00, 
	0x00, 0x0e, 0x16, 0x31, 0x8c, 0x68, 0x70, 0x00, 0x00, 0x00, 0xf6, 0x0e, 0x30, 0x6f, 0x00, 0x00, 
	0x00, 0x00, 0x16, 0x06, 0xa0, 0x68, 0x00, 0x00, 0x00, 0x00, 0x19, 0xc6, 0xa1, 0x98, 0x00, 0x00, 
	0x00, 0x00, 0x03, 0x1e, 0xbc, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0x86, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x0f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// Array of all bitmaps for convenience. (Total bytes used to store images in PROGMEM = 272)
const int epd_bitmap_allArray_LEN = 1;
const unsigned char* epd_bitmap_allArray[1] = {
	epd_bitmap_logo
};
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

int targetY = 24;
int positions[5] = {34, 46, 58, 70, 82};
char letters[5] = {'N','H','K','S','S'};
void setup() {

  Wire.begin(8, 9);
  display.begin(SSD1306_SWITCHCAPVCC, 0x3C);

  // Attach buzzer FIRST (ESP32-C3 style)
  ledcAttach(BUZZER_PIN, 2000, 8);

  // ===== PHASE 1: White Screen =====
  display.fillScreen(SSD1306_WHITE);
  display.display();
  delay(2000);

  introPowerOn();

  // ===== PHASE 2: Drop Letters =====
  for (int i = 0; i < 5; i++) {
    dropLetter(i);
  }

  delay(500);

  // ===== PHASE 3: Black Spread =====
  blackoutSound();
  centerBlackSpread();

  delay(300);

  // ===== LOGO =====
  display.clearDisplay();

  display.drawBitmap(
    (SCREEN_WIDTH - epd_bitmap_logo_width) / 2,
    (SCREEN_HEIGHT - epd_bitmap_logo_height) / 2,
    epd_bitmap_logo,
    epd_bitmap_logo_width,
    epd_bitmap_logo_height,
    SSD1306_WHITE
  );

  display.display();
  logoRevealSound();
}
void toneBeep(int freq, int duration) {
  ledcWriteTone(BUZZER_PIN, freq);
  delay(duration);
  ledcWriteTone(BUZZER_PIN, 0);
  delay(20);
}

void introPowerOn() {
  toneBeep(523, 100);
  toneBeep(659, 100);
  toneBeep(784, 150);
}

void playLetterSound(char letter) {
  switch(letter) {
    case 'N': toneBeep(784, 120); break;
    case 'H': toneBeep(880, 120); break;
    case 'K': toneBeep(1046, 120); break;
    case 'S': toneBeep(1174, 120); break;
  }
}

void blackoutSound() {
  for (int f = 1300; f >= 400; f -= 40) {
    ledcWriteTone(BUZZER_PIN, f);
    delay(10);
  }
  ledcWriteTone(BUZZER_PIN, 0);
}

void logoRevealSound() {
  toneBeep(1046, 150);
  toneBeep(1318, 150);
  toneBeep(1567, 250);

  for (int f = 1500; f >= 300; f -= 20) {
    ledcWriteTone(BUZZER_PIN, f);
    delay(8);
  }

  ledcWriteTone(BUZZER_PIN, 0);
}
void loop() {
}

void drawFixedLetters(int upto) {
  display.setTextSize(2);
  display.setTextColor(SSD1306_BLACK, SSD1306_WHITE);

  for (int i = 0; i < upto; i++) {
    display.setCursor(positions[i], targetY);
    display.print(letters[i]);
  }
}

void dropLetter(int index) {

  for (int y = -20; y <= targetY; y++) {

    display.clearDisplay();
    display.fillScreen(SSD1306_WHITE);

    drawFixedLetters(index);

    display.setTextSize(2);
    display.setTextColor(SSD1306_BLACK, SSD1306_WHITE);
    display.setCursor(positions[index], y);
    display.print(letters[index]);

    display.display();
    delay(15);
  }

  playLetterSound(letters[index]);
  delay(200);
}

void centerBlackSpread() {

  int centerX = SCREEN_WIDTH / 2;
  int centerY = SCREEN_HEIGHT / 2;

  for (int r = 0; r < 80; r++) {
    display.fillCircle(centerX, centerY, r, SSD1306_BLACK);
    display.display();
    delay(10);
  }
}

